---
import BaseLayout from "../layouts/BaseLayout.astro";
import { PrismaClient } from "@prisma/client";
import { precioVES } from "../lib/pricing";

const prisma = new PrismaClient();

// En prod (Vercel) toma el dominio real del request; en dev usa SITE_URL
const ORIGIN = (Astro.url && Astro.url.origin) || process.env.SITE_URL || "";

// Productos activos
const products = await prisma.product.findMany({ where: { active: true } });

// Intento de leer tasa; si falla, mostramos “Tasa no disponible” y seguimos
let fx: any = null;
try {
  const fxRes = await fetch(`${ORIGIN}/api/fx/tasa-ves`, { cache: "no-store" });
  if (fxRes.ok) fx = await fxRes.json();
} catch (_) {}
const tasa = fx?.ema ? Number(fx.ema) : null;

// AEO / JSON-LD
const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Paint Store",
  "url": ORIGIN || "https://paint-mvp-astro.vercel.app",
  "logo": `${ORIGIN || ""}/logo.svg`,
};

function fmtUsd(n: number) { return `$${n.toFixed(2)}`; }
---
<BaseLayout
  title="Catálogo — USD & VES"
  description="Catálogo con precios en USD y VES (tasa Binance EMA)"
  jsonld={orgJsonLd}
>
  <!-- Si tu fonts.css está en /public, este path funciona -->
  <link rel="stylesheet" href="/fonts.css" />

  <header class="container">
    <span class="logo"></span>
    <div>
      <div class="badge">MVP Paso 2</div>
      <h1>Catálogo (USD / VES)</h1>
      <p style="color:var(--muted)">
        {tasa
          ? `Tasa Binance (EMA): ${tasa.toLocaleString('es-VE', { maximumFractionDigits: 2 })} VES`
          : "Tasa no disponible"}
      </p>
    </div>
  </header>

  <main class="container card">
    <table class="table">
      <thead>
        <tr><th>SKU</th><th>Producto</th><th>Presentación</th><th>USD</th><th>VES</th></tr>
      </thead>
      <tbody>
        {products.map((p) => {
          const usd = Number(p.costBaseUsd) * (1 + Number(p.margin));
          const ves = tasa
            ? precioVES({
                costoBaseUSD: Number(p.costBaseUsd),
                margen: Number(p.margin),
                tasaVES: tasa,
              })
            : null;

          return (
            <tr>
              <td>{p.sku}</td>
              <td>{p.name}</td>
              <td>{p.sizeMl} ml</td>
              <td>{fmtUsd(usd)}</td>
              <td>{ves ? ves.toLocaleString("es-VE") + " VES" : "—"}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </main>
</BaseLayout>
